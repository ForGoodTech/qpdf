<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>qpdf wasm demo</title>
</head>
<body>
  <input type="file" id="file" accept="application/pdf" />
  <button id="run">Compress</button>
  <script src="qpdf-wasm.js"></script>
  <script>
    let ready = false;
    let qpdf;

    Module().then((mod) => {
      qpdf = mod;
      ready = true;
    });

    document.getElementById('run').addEventListener('click', async () => {
      if (!ready) {
        alert('WASM not initialized yet');
        return;
      }
      const fi = document.getElementById('file');
      if (!fi.files.length) {
        alert('Select a PDF first');
        return;
      }
      const file = fi.files[0];
      const buf = new Uint8Array(await file.arrayBuffer());
      const input = 'input.pdf';
      const output = 'output.pdf';
      // qpdf.FS is Emscripten's in-memory filesystem used to pass data between
      // JavaScript and the WebAssembly module.
      if (!qpdf.FS) {
        alert('Filesystem support not available in this build');
        return;
      }
      qpdf.FS.writeFile(input, buf);
      qpdf.ccall('qpdf_wasm_compress', 'number', ['string', 'string'], [input, output]);
      const out = qpdf.FS.readFile(output);
      const blob = new Blob([out], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'compressed.pdf';
      a.click();
      URL.revokeObjectURL(url);
      qpdf.FS.unlink(input);
      qpdf.FS.unlink(output);
    });
  </script>
</body>
</html>
